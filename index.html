<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filter Kepala, Ekor, Angka Main & Shio</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <h1 class="text-2xl font-bold mb-4">Filter Data: Kepala, Ekor, Angka Main & Shio</h1>

  <div class="bg-white p-4 rounded-lg shadow mb-6 grid gap-4">
    <div>
      <label class="block mb-1 font-medium">Kepala (max 7 digit tanpa spasi)</label>
      <textarea id="angkaKepala" rows="1" maxlength="7" class="w-full border rounded-lg px-3 py-2"></textarea>
    </div>
    <div>
      <label class="block mb-1 font-medium">Ekor (max 7 digit tanpa spasi)</label>
      <textarea id="angkaEkor" rows="1" maxlength="7" class="w-full border rounded-lg px-3 py-2"></textarea>
    </div>
    <div>
      <label class="block mb-1 font-medium">Angka Main (max 10 baris, max 7 digit/baris)</label>
      <textarea id="angkaMain" rows="10" class="w-full border rounded-lg px-3 py-2"></textarea>
    </div>
    <div>
      <label class="block mb-1 font-medium">Shio (pisahkan dengan koma, contoh: 1,2,3)</label>
      <textarea id="shioInput" rows="1" placeholder="Contoh: 1,2,3" class="w-full border rounded-lg px-3 py-2"></textarea>
    </div>
    <div>
      <button id="prosesBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Proses</button>
      <span id="loading" class="hidden ml-2 text-blue-600">Memproses...</span>
    </div>
  </div>

  <div id="table-wrap" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>

  <script>
    const SHEET_ID = '1AVLTOow3t_5vdBfa_S8hUNKo15vYpRYq8FZheRlallY';
    const SHEET_NAME = 'GABUNG';
    const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;
    const tableWrap = document.getElementById('table-wrap');
    const prosesBtn = document.getElementById('prosesBtn');
    const loadingEl = document.getElementById('loading');
    let lastData = null;

    const shioMap = {
      1: ["01","13","25","37","49","61","73","85","97"],
      2: ["02","14","26","38","50","62","74","86","98"],
      3: ["03","15","27","39","51","63","75","87","99"],
      4: ["04","16","28","40","52","64","76","88","00"],
      5: ["05","17","29","41","53","65","77","89"],
      6: ["06","18","30","42","54","66","78","90"],
      7: ["07","19","31","43","55","67","79","91"],
      8: ["08","20","32","44","56","68","80","92"],
      9: ["09","21","33","45","57","69","81","93"],
      10:["10","22","34","46","58","70","82","94"],
      11:["11","23","35","47","59","71","83","95"],
      12:["12","24","36","48","60","72","84","96"]
    };

    async function fetchSheet() {
      tableWrap.innerHTML = '<p>Memuat dataâ€¦</p>';
      try {
        const res = await fetch(gvizUrl);
        const text = await res.text();
        const jsonText = text.replace(/^.*setResponse\(|\);\s*$/gs, '');
        const obj = JSON.parse(jsonText);
        lastData = obj.table;
        renderTable(lastData.rows.map(r => r.c.map(c => c?.v ?? "")), lastData.cols.map(c => c.label || ""));
      } catch (err) {
        tableWrap.innerHTML = `<p class='text-red-600'>Gagal memuat data<br>${err.message}</p>`;
      }
    }

    function renderTable(rows, headers) {
      let html = `<table class="table-auto border-collapse w-full text-sm">`;
      html += `<thead><tr>${headers.map(h => `<th class="border px-3 py-2 bg-gray-100">${h}</th>`).join('')}</tr></thead>`;
      html += `<tbody>`;
      rows.forEach(r => {
        html += `<tr>${r.map(cell => `<td class="border px-3 py-1">${cell}</td>`).join('')}</tr>`;
      });
      html += `</tbody></table>`;
      tableWrap.innerHTML = html;
    }

    function filterData() {
      if (!lastData) return;

      const kepala = document.getElementById('angkaKepala').value.trim();
      const ekor = document.getElementById('angkaEkor').value.trim();
      const angkaMain = document.getElementById('angkaMain').value.trim().split(/\n/).map(x => x.trim()).filter(Boolean);
      const shioInput = document.getElementById('shioInput').value.trim().split(',').map(x => parseInt(x,10)).filter(n => !isNaN(n) && n >= 1 && n <= 12);

      const shioList = new Set();
      shioInput.forEach(s => shioMap[s].forEach(num => shioList.add(num)));

      const cols = lastData.cols.map(c => c.label || "");
      const rows = lastData.rows.map(r => r.c.map(c => c?.v ?? ""));

      const filtered = rows.filter(row => {
        const nomor = String(row[0]); // asumsi kolom pertama adalah nomor
        if (nomor.length < 5) return false;

        const digitKepala = nomor[3]; // digit ke-4
        const digitEkor = nomor[4];   // digit ke-5

        // Cek kepala sesuai input
        if (kepala && !kepala.includes(digitKepala)) return false;
        // Cek ekor sesuai input
        if (ekor && !ekor.includes(digitEkor)) return false;

        // Cek angka main
        const matchMain = angkaMain.some(main => nomor.includes(main));
        if (angkaMain.length > 0 && !matchMain) return false;

        // Cek shio
        const lastTwo = nomor.slice(-2).padStart(2,"0");
        if (shioList.size > 0 && !shioList.has(lastTwo)) return false;

        return true;
      });

      renderTable(filtered, cols);
    }

    prosesBtn.addEventListener('click', () => {
      loadingEl.classList.remove('hidden');
      setTimeout(() => {
        filterData();
        loadingEl.classList.add('hidden');
      }, 300); // delay 300ms biar keliatan loading
    });

    fetchSheet();
  </script>
</body>
</html>
