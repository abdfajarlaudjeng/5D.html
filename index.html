<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Filter Data Sheet GABUNG</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

<h1 class="text-2xl font-bold mb-4">Filter Data Sheet GABUNG</h1>

<div class="bg-white p-4 rounded-lg shadow mb-6 grid gap-4 md:grid-cols-3">
  <div>
    <label class="block font-medium mb-1">Kepala (max 7 digit)</label>
    <textarea id="kepala" rows="3" maxlength="7" placeholder="Contoh: 678901" class="w-full border rounded-lg p-2"></textarea>
  </div>
  <div>
    <label class="block font-medium mb-1">Ekor (max 7 digit)</label>
    <textarea id="ekor" rows="3" maxlength="7" placeholder="Contoh: 234567" class="w-full border rounded-lg p-2"></textarea>
  </div>
  <div>
    <label class="block font-medium mb-1">Angka Main (max 10 baris, 7 digit per baris)</label>
    <textarea id="angkaMain" rows="5" placeholder="Contoh:\n678901\n123456" class="w-full border rounded-lg p-2"></textarea>
  </div>
</div>

<div class="flex gap-2 mb-4">
  <button id="proses" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Proses</button>
  <button id="copy" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Copy Hasil</button>
</div>

<div id="loading" class="hidden mb-4 text-blue-600 font-medium">Memproses...</div>

<div id="resultCount" class="mb-2 text-gray-700"></div>
<div id="table-wrap" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>

<script>
const SHEET_ID = '1AVLTOow3t_5vdBfa_S8hUNKo15vYpRYq8FZheRlallY';
const SHEET_NAME = 'GABUNG';
const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;

let sheetData = [];

async function fetchSheet() {
  const res = await fetch(gvizUrl);
  const text = await res.text();
  const jsonText = text.replace(/^.*setResponse\(|\);\s*$/gs, '');
  const obj = JSON.parse(jsonText);
  const rows = obj.table.rows.map(r => r.c.map(c => c ? String(c.v) : ""));
  return rows;
}

function filterData() {
  const kepala = document.getElementById('kepala').value.trim();
  const ekor = document.getElementById('ekor').value.trim();
  const angkaMainLines = document.getElementById('angkaMain').value.trim().split(/\n/).filter(l => l);

  const kepalaSet = new Set(kepala.split(""));
  const ekorSet = new Set(ekor.split(""));
  const angkaMainSet = new Set(angkaMainLines.join("").split(""));

  return sheetData.filter(row => {
    const nomor = row[0]; // anggap kolom pertama berisi nomor
    if (!nomor || nomor.length < 5) return false;

    const kepalaDigit = nomor[3];
    const ekorDigit = nomor[4];

    if (!kepalaSet.has(kepalaDigit)) return false;
    if (!ekorSet.has(ekorDigit)) return false;

    // harus ada salah satu dari angka main di kepala atau ekor
    if (!(angkaMainSet.has(kepalaDigit) || angkaMainSet.has(ekorDigit))) return false;

    return true;
  });
}

function renderTable(rows) {
  if (!rows.length) {
    document.getElementById('table-wrap').innerHTML = "<p class='text-red-600'>Tidak ada data yang cocok.</p>";
    return;
  }
  let html = `<table class="table-auto border-collapse w-full">
    <thead><tr>${rows[0].map(h => `<th class="border px-3 py-2 bg-gray-100">${h}</th>`).join("")}</tr></thead>
    <tbody>`;
  rows.slice(1).forEach(r => {
    html += `<tr>${r.map(cell => `<td class="border px-3 py-2">${cell}</td>`).join("")}</tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('table-wrap').innerHTML = html;
}

document.getElementById('proses').addEventListener('click', async () => {
  document.getElementById('loading').classList.remove('hidden');
  if (sheetData.length === 0) {
    sheetData = await fetchSheet();
  }
  const filtered = [sheetData[0], ...filterData()];
  document.getElementById('resultCount').textContent = `${filtered.length - 1} data ditemukan`;
  renderTable(filtered);
  document.getElementById('loading').classList.add('hidden');
});

document.getElementById('copy').addEventListener('click', () => {
  const rows = filterData();
  const text = rows.map(r => r.join("\t")).join("\n");
  navigator.clipboard.writeText(text);
  alert("Hasil disalin ke clipboard!");
});
</script>

</body>
</html>
