<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filter Kepala & Ekor — Sheet GABUNG</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

  <header class="mb-6">
    <h1 class="text-2xl font-bold">Filter Kepala & Ekor dari Sheet <span class="text-blue-600">GABUNG</span></h1>
  </header>

  <!-- Input Form -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div>
        <label for="kepalaInput" class="block mb-1 font-medium">Kepala (max 7 digit)</label>
        <input id="kepalaInput" type="text" maxlength="7" pattern="\d*" placeholder="Contoh: 1234567" class="w-full border rounded-lg px-3 py-2" />
      </div>
      <div>
        <label for="ekorInput" class="block mb-1 font-medium">Ekor (max 7 digit)</label>
        <input id="ekorInput" type="text" maxlength="7" pattern="\d*" placeholder="Contoh: 7654321" class="w-full border rounded-lg px-3 py-2" />
      </div>
      <div>
        <label for="angkaMainInput" class="block mb-1 font-medium">Angka Main (max 7 digit)</label>
        <input id="angkaMainInput" type="text" maxlength="7" pattern="\d*" placeholder="Contoh: 6789012" class="w-full border rounded-lg px-3 py-2" />
      </div>
    </div>
    <div class="flex gap-2">
      <button id="prosesBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
        <span>Proses</span>
        <span id="loadingSpinner" class="hidden animate-spin border-2 border-white border-t-transparent rounded-full w-4 h-4"></span>
      </button>
      <button id="copyBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Copy Hasil</button>
    </div>
  </div>

  <div id="resultCount" class="mb-2 text-sm text-gray-600"></div>
  <div id="table-wrap" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>

  <script>
    const SHEET_ID = '1AVLTOow3t_5vdBfa_S8hUNKo15vYpRYq8FZheRlallY';
    const SHEET_NAME = 'GABUNG';
    const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;

    const tableWrap = document.getElementById('table-wrap');
    const resultCount = document.getElementById('resultCount');
    const prosesBtn = document.getElementById('prosesBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const copyBtn = document.getElementById('copyBtn');

    let lastData = null;

    async function fetchSheet() {
      tableWrap.innerHTML = '<p>Memuat data…</p>';
      try {
        const res = await fetch(gvizUrl);
        const text = await res.text();
        const jsonText = text.replace(/^.*setResponse\(|\);\s*$/gs, '');
        const obj = JSON.parse(jsonText);
        lastData = obj.table;
        tableWrap.innerHTML = '<p>Data siap. Silakan masukkan filter dan klik Proses.</p>';
      } catch (err) {
        tableWrap.innerHTML = `<p class='text-red-600'>Gagal memuat data.<br><small>${err.message}</small></p>`;
      }
    }

    function filterData() {
      const kepalaStr = document.getElementById('kepalaInput').value.trim();
      const ekorStr = document.getElementById('ekorInput').value.trim();
      const mainStr = document.getElementById('angkaMainInput').value.trim();

      if (!lastData) return;
      if (!kepalaStr || !ekorStr || !mainStr) {
        alert('Isi semua kolom dengan angka!');
        return;
      }

      const cols = lastData.cols.map(c => c.label || c.id || '');
      const rows = lastData.rows.map(r => r.c.map(cell => cell && cell.v !== null ? String(cell.v) : ''));

      // Asumsikan kolom pertama adalah nomor yang mau difilter
      const filtered = rows.filter(r => {
        const nomor = r[0];
        if (!nomor || nomor.length < 2) return false;

        const digitKepala = nomor[0];
        const digitEkor = nomor[nomor.length - 1];

        const kepalaMatch = kepalaStr.includes(digitKepala);
        const ekorMatch = ekorStr.includes(digitEkor);

        const kepalaContainsMain = [...digitKepala].some(d => mainStr.includes(d));
        const ekorContainsMain = [...digitEkor].some(d => mainStr.includes(d));

        return kepalaMatch && ekorMatch && (kepalaContainsMain || ekorContainsMain);
      });

      renderTable(cols, filtered);
    }

    function renderTable(cols, rows) {
      let html = `<table class='table-auto border-collapse w-full text-sm'>`;
      html += `<thead><tr>${cols.map(h => `<th class='border px-3 py-2 bg-gray-100'>${h}</th>`).join('')}</tr></thead>`;
      html += `<tbody>`;
      rows.forEach(r => {
        html += `<tr>${r.map(cell => `<td class='border px-3 py-2'>${cell}</td>`).join('')}</tr>`;
      });
      html += `</tbody></table>`;
      tableWrap.innerHTML = html;
      resultCount.textContent = `Hasil: ${rows.length} baris ditemukan`;
    }

    prosesBtn.addEventListener('click', () => {
      loadingSpinner.classList.remove('hidden');
      setTimeout(() => {
        filterData();
        loadingSpinner.classList.add('hidden');
      }, 300); // delay biar kelihatan loading
    });

    copyBtn.addEventListener('click', () => {
      const text = tableWrap.innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert('Hasil disalin ke clipboard');
      });
    });

    fetchSheet();
  </script>

</body>
</html>
