<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sheet GABUNG — Filter Kepala, Ekor, Angka Main, Shio</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <header class="mb-6">
    <h1 class="text-2xl font-bold">Data: Sheet <span class="text-blue-600">GABUNG</span></h1>
  </header>

  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-lg font-semibold mb-4">Input Filter</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="angkaKepala" class="block mb-1 font-medium">Kepala (max 7 digit)</label>
        <textarea id="angkaKepala" rows="1" placeholder="Contoh: 6789012" class="w-full border rounded-lg px-3 py-2"></textarea>
      </div>
      <div>
        <label for="angkaEkor" class="block mb-1 font-medium">Ekor (max 7 digit)</label>
        <textarea id="angkaEkor" rows="1" placeholder="Contoh: 3456789" class="w-full border rounded-lg px-3 py-2"></textarea>
      </div>
      <div>
        <label for="angkaMain" class="block mb-1 font-medium">Angka Main (max 10 baris, 7 digit per baris)</label>
        <textarea id="angkaMain" rows="5" placeholder="Masukkan angka main" class="w-full border rounded-lg px-3 py-2"></textarea>
      </div>
      <div>
        <label for="shioInput" class="block mb-1 font-medium">Shio (1–12, pisah koma)</label>
        <textarea id="shioInput" rows="1" placeholder="Contoh: 1,3,5" class="w-full border rounded-lg px-3 py-2"></textarea>
      </div>
    </div>
    <div class="mt-4">
      <button id="prosesBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Proses</button>
      <span id="loading" class="hidden ml-3 text-gray-500">Memproses...</span>
    </div>
  </div>

  <div id="table-wrap" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>

  <script>
    const SHEET_ID = '1AVLTOow3t_5vdBfa_S8hUNKo15vYpRYq8FZheRlallY';
    const SHEET_NAME = 'GABUNG';
    const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;

    const tableWrap = document.getElementById('table-wrap');
    const prosesBtn = document.getElementById('prosesBtn');
    const loadingEl = document.getElementById('loading');

    const kepalaEl = document.getElementById('angkaKepala');
    const ekorEl = document.getElementById('angkaEkor');
    const angkaMainEl = document.getElementById('angkaMain');
    const shioEl = document.getElementById('shioInput');

    let lastData = null;

    // Mapping Shio
    const shioMap = {
      1: ['01','13','25','37','49','61','73','85','97'],
      2: ['02','14','26','38','50','62','74','86','98'],
      3: ['03','15','27','39','51','63','75','87','99'],
      4: ['04','16','28','40','52','64','76','88'],
      5: ['05','17','29','41','53','65','77','89'],
      6: ['06','18','30','42','54','66','78','90'],
      7: ['07','19','31','43','55','67','79','91'],
      8: ['08','20','32','44','56','68','80','92'],
      9: ['09','21','33','45','57','69','81','93'],
      10:['10','22','34','46','58','70','82','94'],
      11:['11','23','35','47','59','71','83','95'],
      12:['12','24','36','48','60','72','84','96']
    };

    // Validasi input
    ['angkaKepala', 'angkaEkor'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', () => {
        el.value = el.value.replace(/\D/g, '').slice(0, 7);
      });
    });

    angkaMainEl.addEventListener('input', () => {
      let lines = angkaMainEl.value.split(/\n/).map(l => l.replace(/\D/g, '').slice(0, 7));
      if (lines.length > 10) lines = lines.slice(0, 10);
      angkaMainEl.value = lines.join('\n');
    });

    shioEl.addEventListener('input', () => {
      shioEl.value = shioEl.value
        .split(',')
        .map(s => s.trim())
        .filter(s => /^\d{1,2}$/.test(s) && +s >= 1 && +s <= 12)
        .join(',');
    });

    async function fetchSheet() {
      tableWrap.innerHTML = '<p>Memuat data…</p>';
      try {
        const res = await fetch(gvizUrl);
        const text = await res.text();
        const jsonText = text.replace(/^.*setResponse\(|\);\s*$/gs, '');
        const obj = JSON.parse(jsonText);
        lastData = obj.table;
        renderTable(lastData.rows.map(r => r.c.map(cell => cell && cell.v !== null ? cell.v : '')), lastData.cols.map(c => c.label || c.id || ''));
      } catch (err) {
        tableWrap.innerHTML = `<p class='text-red-600'>Gagal memuat data.<br><small>${err.message}</small></p>`;
      }
    }

    function renderTable(rows, cols) {
      let html = `<table class='table-auto border-collapse w-full'>`;
      html += `<thead><tr>${cols.map(h => `<th class='border px-3 py-2 bg-gray-100'>${h}</th>`).join('')}</tr></thead>`;
      html += `<tbody>`;
      rows.forEach(r => {
        html += `<tr>${r.map(cell => `<td class='border px-3 py-2'>${cell}</td>`).join('')}</tr>`;
      });
      html += `</tbody></table>`;
      tableWrap.innerHTML = html;
    }

    function filterData() {
      if (!lastData) return;
      const kepalaStr = kepalaEl.value;
      const ekorStr = ekorEl.value;
      const angkaMainList = angkaMainEl.value.split(/\n/).filter(Boolean);
      const shioList = shioEl.value.split(',').map(s => s.trim()).filter(Boolean);

      const cols = lastData.cols.map(c => c.label || c.id || '');
      const rows = lastData.rows.map(r => r.c.map(cell => cell && cell.v !== null ? String(cell.v) : ''));

      const filtered = rows.filter(r => {
        const num = r[0]; // kolom pertama sebagai nomor
        if (!num || num.length < 5) return false;

        const kepala = num[3];
        const ekor = num[4];

        const kepalaOk = kepalaStr.includes(kepala);
        const ekorOk = ekorStr.includes(ekor);

        // Filter angka main
        const mainOk = angkaMainList.some(main => kepala.includesAny?.(main) || ekor.includesAny?.(main) || main.includes(kepala) || main.includes(ekor));

        // Filter Shio
        let shioOk = true;
        if (shioList.length > 0) {
          const duaDigit = num.slice(-2);
          shioOk = shioList.some(shioNum => shioMap[shioNum].includes(duaDigit));
        }

        return kepalaOk && ekorOk && mainOk && shioOk;
      });

      renderTable(filtered, cols);
    }

    prosesBtn.addEventListener('click', () => {
      loadingEl.classList.remove('hidden');
      setTimeout(() => {
        filterData();
        loadingEl.classList.add('hidden');
      }, 300); // simulasi loading cepat
    });

    fetchSheet();
  </script>
</body>
</html>
